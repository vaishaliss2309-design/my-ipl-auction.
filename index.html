<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPL Pro Auction - Live Sync</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --dark: #001d3d; --blue: #003566; --gold: #ffc300;
            --light: #f8f9fa; --danger: #d00000; --success: #28a745;
        }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: var(--light); margin: 0; color: #333; }
        .nav { background: var(--dark); padding: 15px; display: none; justify-content: center; gap: 10px; position: sticky; top: 0; z-index: 1000; flex-wrap: wrap;}
        .nav-btn { padding: 10px; background: var(--blue); color: white; border: 1px solid var(--gold); cursor: pointer; border-radius: 5px; font-weight: bold; flex: 1; text-align: center; font-size: 14px;}
        .nav-btn.active { background: var(--gold); color: var(--dark); }
        .container { padding: 15px; max-width: 1200px; margin: auto; }
        .page { display: none; }
        .page.active { display: block; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; border-top: 5px solid var(--gold); }
        input, select { padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; width: 100%; box-sizing: border-box; margin-bottom: 10px;}
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; font-size: 14px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: var(--dark); color: var(--gold); }
        .row-highlight { background-color: #e2e8f0 !important; font-weight: bold; }
        .bid-btn { background: var(--gold); color: var(--dark); border: none; padding: 15px; font-size: 24px; font-weight: bold; border-radius: 10px; cursor: pointer; width: 100%; margin-top: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.2);}
        .bid-btn:active { transform: scale(0.98); }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; color: white; font-weight: bold; }
        .WK { background: #e63946; } .Batter { background: #457b9d; } .Bowler { background: #1d3557; } .AR { background: #fb8500; }
        
        /* Admin specific hiding class */
        .admin-only { display: none; }
        
        @media (max-width: 600px) {
            #auctionDisplay h1 { font-size: 30px !important; }
        }
    </style>
</head>
<body>

<div id="rolePage" class="page active" style="text-align:center; padding-top: 50px;">
    <div class="card" style="max-width: 400px; margin: auto;">
        <h1>üèè IPL Auction</h1>
        <p>Choose your role to enter:</p>
        <button onclick="setRole('admin')" style="background:var(--dark); color:white; padding:15px; width:100%; font-size:18px; margin-bottom:15px; border-radius:8px; border:none;">I am ADMIN (Control Room)</button>
        <button onclick="setRole('user')" style="background:var(--blue); color:white; padding:15px; width:100%; font-size:18px; border-radius:8px; border:none;">I am TEAM OWNER (Join Auction)</button>
    </div>
</div>

<div id="setupPage" class="page" style="text-align:center; padding-top: 20px;">
    <div class="card" style="max-width: 600px; margin: auto;">
        <h2>Add Your Team</h2>
        <input type="text" id="tName" placeholder="Enter Team Name">
        <input type="number" id="tPurse" placeholder="Total Purse (Cr) e.g. 100" value="100">
        <button onclick="addTeam()" style="background:var(--blue); color:white; border:none; padding:12px; border-radius:5px; width:100%; font-size: 16px; margin-bottom: 15px;">+ Add Team to Auction</button>
        
        <div id="teamPreview" style="text-align: left; margin-bottom: 20px; background: #eee; padding: 10px; border-radius: 5px;"></div>
        <button class="nav-btn" style="width: 100%; padding: 15px;" onclick="enterAuction()">ENTER AUCTION ROOM</button>
    </div>
</div>

<div id="mainNav" class="nav">
    <button class="nav-btn" onclick="showPage('masterPage')">PLAYER LIST</button>
    <button class="nav-btn active" onclick="showPage('livePage')">LIVE AUCTION</button>
    <button class="nav-btn" onclick="showPage('dashboardPage')">TEAM SHEETS</button>
</div>

<div class="container">
    
    <div id="masterPage" class="page">
        <div class="card">
            <h2>Player List</h2>
            <div class="admin-only" style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; background: #f1f5f9; padding: 10px; border-radius: 8px;">
                <input type="text" id="pName" placeholder="Player Name" style="flex:1; min-width:150px;">
                <select id="pRole" style="flex:1; min-width:100px;">
                    <option value="Batter">Batter</option>
                    <option value="Bowler">Bowler</option>
                    <option value="WK">WK</option>
                    <option value="AR">All-Rounder</option>
                </select>
                <input type="number" id="pBase" placeholder="Base Price (Cr)" style="flex:1; min-width:100px;">
                <button onclick="addPlayerToMaster()" style="background:var(--blue); color:white; border:none; padding:10px; border-radius:5px; width:100%;">Add Player</button>
            </div>
            
            <div style="overflow-x:auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Role</th>
                            <th>Base</th>
                            <th>Status</th>
                            <th id="thAction" class="admin-only">Action</th>
                        </tr>
                    </thead>
                    <tbody id="masterTbody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="livePage" class="page">
        <div class="card" style="text-align: center;">
            
            <div class="admin-only" style="background: #e2e8f0; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                <h3>Admin Control</h3>
                <select id="selectFromMaster" onchange="loadPlayerToAuction()"></select>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <select id="adminSellingTeam" style="flex:2;"></select>
                    <button onclick="sellPlayer()" style="background: var(--success); color: white; padding: 10px; border: none; border-radius: 5px; flex:1;">SOLD</button>
                    <button onclick="markUnsold()" style="background: var(--danger); color: white; padding: 10px; border: none; border-radius: 5px; flex:1;">UNSOLD</button>
                </div>
            </div>

            <div id="auctionDisplay" style="background: var(--dark); color: var(--gold); padding: 30px 10px; border-radius: 15px; border: 3px solid var(--gold);">
                <h1 id="liveDispName" style="font-size: 40px; margin: 0;">WAITING FOR ADMIN</h1>
                <p id="liveDispInfo">-</p>
                <div style="font-size: 35px; margin-top: 15px; color: white;">Current Bid: <span id="currentBidLabel" style="color:var(--gold); font-weight:bold;">0.00</span> Cr</div>
                <p style="color: #fff; font-size: 18px; margin-top: 5px;">Highest Bidder: <span id="highestBidderLabel" style="color: #4cc9f0; font-weight:bold;">None</span></p>
            </div>
            
            <div style="margin-top: 20px;">
                <select id="myTeamSelect" style="background: #e9ecef; font-weight: bold; text-align:center;">
                    <option value="">-- Select Your Team to Bid --</option>
                </select>
                <button class="bid-btn" onclick="placeBid()">üî• PLACE BID (+)</button>
            </div>
        </div>
    </div>

    <div id="dashboardPage" class="page">
        <div id="teamSheetsContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;"></div>
        <button class="admin-only" onclick="resetAllData()" style="background: #333; color: white; padding: 10px; border: none; cursor: pointer; margin-top: 30px; width: 100%;">RESET ALL DATABASE (Admin Only)</button>
    </div>
</div>

<script>
    // 1. FIREBASE CONFIGURATION
    const firebaseConfig = {
      apiKey: "AIzaSyDUJtHfviF4dYWVCuewXrAj1c5q0ETgQxQ",
      authDomain: "ipl-live-action.firebaseapp.com",
      databaseURL: "https://ipl-live-action-default-rtdb.firebaseio.com",
      projectId: "ipl-live-action",
      storageBucket: "ipl-live-action.firebasestorage.app",
      messagingSenderId: "353231465465",
      appId: "1:353231465465:web:e4ae774ca0fb91c4ee2b28"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Global Variables
    let myRole = ''; 
    let teams = [];
    let masterPlayers = [];
    let liveState = { playerId: null, price: 0, bidder: 'None' };

    // --- INITIAL SETUP & ROLE ---
    function setRole(role) {
        myRole = role;
        document.getElementById('rolePage').style.display = 'none';
        document.getElementById('setupPage').style.display = 'block';
        
        // Show/Hide Admin elements based on role
        if(role === 'admin') {
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = el.tagName === 'TH' ? 'table-cell' : 'block');
        } else {
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
        }
    }

    function enterAuction() {
        document.getElementById('setupPage').style.display = 'none';
        document.getElementById('mainNav').style.display = 'flex';
        showPage('livePage');
    }

    function showPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
    }

    // --- FIREBASE REAL-TIME LISTENERS ---
    
    // Listen to Teams
    db.ref('teams').on('value', (snapshot) => {
        let data = snapshot.val();
        teams = data ? Object.values(data) : [];
        updateTeamDropdowns();
        renderTeamSheets();
        
        let previewHtml = teams.map(t => `<b>${t.name}</b> (${t.currentPurse} Cr)`).join('<br>');
        document.getElementById('teamPreview').innerHTML = previewHtml;
    });

    // Listen to Players
    db.ref('players').on('value', (snapshot) => {
        let data = snapshot.val();
        masterPlayers = data ? Object.values(data) : [];
        renderMaster();
        updateAdminPlayerSelect();
    });

    // Listen to Live Auction State
    db.ref('liveAuction').on('value', (snapshot) => {
        let data = snapshot.val();
        if(data) {
            liveState = data;
            if(liveState.playerId) {
                let p = masterPlayers.find(x => x.id == liveState.playerId);
                if(p) {
                    document.getElementById('liveDispName').innerText = p.name;
                    document.getElementById('liveDispInfo').innerText = `${p.role} | Base: ${p.base} Cr`;
                    document.getElementById('currentBidLabel').innerText = liveState.price.toFixed(2);
                    document.getElementById('highestBidderLabel').innerText = liveState.bidder;
                }
            } else {
                document.getElementById('liveDispName').innerText = "WAITING FOR ADMIN";
                document.getElementById('liveDispInfo').innerText = "-";
                document.getElementById('currentBidLabel').innerText = "0.00";
                document.getElementById('highestBidderLabel').innerText = "None";
            }
        }
    });


    // --- FUNCTIONS ---

    function addTeam() {
        let name = document.getElementById('tName').value.trim();
        let purse = parseFloat(document.getElementById('tPurse').value);
        if(!name) return;
        
        let teamId = "T_" + Date.now();
        db.ref('teams/' + teamId).set({
            id: teamId,
            name: name,
            currentPurse: purse,
            players: []
        });
        document.getElementById('tName').value = '';
    }

    function addPlayerToMaster() {
        let name = document.getElementById('pName').value.trim();
        let role = document.getElementById('pRole').value;
        let base = parseFloat(document.getElementById('pBase').value);
        if(!name || isNaN(base)) return;
        
        let pId = "P_" + Date.now();
        db.ref('players/' + pId).set({
            id: pId,
            name: name,
            role: role,
            base: base,
            status: 'Available'
        });
        document.getElementById('pName').value = '';
    }

    function renderMaster() {
        let tbodyHtml = '';
        masterPlayers.forEach((p) => {
            let deleteBtnHtml = myRole === 'admin' ? `<td><button onclick="deletePlayer('${p.id}')" style="background:var(--danger);color:white;border:none;padding:5px; border-radius:4px;">Del</button></td>` : '';
            tbodyHtml += `
                <tr style="${p.status === 'SOLD' ? 'opacity:0.4' : ''}">
                    <td>${p.name}</td><td><span class="badge ${p.role}">${p.role}</span></td>
                    <td>${p.base}</td><td>${p.status}</td>
                    ${deleteBtnHtml}
                </tr>
            `;
        });
        document.getElementById('masterTbody').innerHTML = tbodyHtml;
    }

    function deletePlayer(id) {
        if(confirm("Delete Player?")) db.ref('players/' + id).remove();
    }

    function updateTeamDropdowns() {
        let opts = '<option value="">-- Select Team --</option>';
        teams.forEach(t => opts += `<option value="${t.id}">${t.name} (Purse: ${t.currentPurse.toFixed(2)} Cr)</option>`);
        document.getElementById('myTeamSelect').innerHTML = opts;
        
        if(myRole === 'admin') {
            document.getElementById('adminSellingTeam').innerHTML = opts;
        }
    }

    function updateAdminPlayerSelect() {
        if(myRole !== 'admin') return;
        let mSel = document.getElementById('selectFromMaster');
        mSel.innerHTML = '<option value="">-- Select Player for Live Screen --</option>';
        masterPlayers.forEach(p => {
            if(p.status === 'Available' || p.status === 'UNSOLD') {
                mSel.innerHTML += `<option value="${p.id}">${p.name} (${p.status})</option>`;
            }
        });
    }

    // Admin Action: Push player to Live Screen
    function loadPlayerToAuction() {
        let pId = document.getElementById('selectFromMaster').value;
        if(pId === "") {
            db.ref('liveAuction').set({ playerId: null, price: 0, bidder: 'None' });
            return;
        }
        let p = masterPlayers.find(x => x.id === pId);
        db.ref('liveAuction').set({ playerId: p.id, price: p.base, bidder: 'Base Price' });
    }

    // User/Admin Action: Place Bid
    function placeBid() {
        if(!liveState.playerId) return alert("Auction not active!");
        let myTeamId = document.getElementById('myTeamSelect').value;
        if(!myTeamId) return alert("Please select your team first!");
        
        let team = teams.find(t => t.id === myTeamId);
        
        let currentPrice = liveState.price;
        let inc = (currentPrice >= 20) ? 1.0 : (currentPrice >= 10 ? 0.5 : 0.25);
        let newPrice = currentPrice + inc;

        if(team.currentPurse < newPrice) return alert("Not enough budget!");

        db.ref('liveAuction').update({
            price: newPrice,
            bidder: team.name
        });
    }

    // Admin Action: Sell
    function sellPlayer() {
        let tId = document.getElementById('adminSellingTeam').value;
        if(!tId || !liveState.playerId) return alert("Select Player and Team!");
        
        let team = teams.find(t => t.id === tId);
        let p = masterPlayers.find(x => x.id === liveState.playerId);
        
        if(team.currentPurse < liveState.price) return alert("Team doesn't have enough purse!");

        // Update Team
        let updatedPurse = team.currentPurse - liveState.price;
        let playerList = team.players || [];
        playerList.push({ name: p.name, role: p.role, price: liveState.price });
        
        db.ref('teams/' + team.id).update({
            currentPurse: updatedPurse,
            players: playerList
        });

        // Update Player Status
        db.ref('players/' + p.id).update({ status: 'SOLD' });
        
        // Clear Live Screen
        db.ref('liveAuction').set({ playerId: null, price: 0, bidder: 'SOLD!' });
        document.getElementById('selectFromMaster').value = "";
        alert("Player Sold to " + team.name);
    }

    // Admin Action: Unsold
    function markUnsold() {
        if(!liveState.playerId) return;
        db.ref('players/' + liveState.playerId).update({ status: 'UNSOLD' });
        db.ref('liveAuction').set({ playerId: null, price: 0, bidder: 'UNSOLD' });
        document.getElementById('selectFromMaster').value = "";
    }

    function renderTeamSheets() {
        let cont = document.getElementById('teamSheetsContainer');
        cont.innerHTML = '';
        teams.forEach(t => {
            let plist = t.players || [];
            let rows = '';
            for(let i=0; i<15; i++) {
                let p = plist[i];
                rows += `<tr><td>${i+1}</td><td>${p?p.name:'-'}</td><td>${p?p.role:'-'}</td><td>${p?p.price.toFixed(2):'-'}</td></tr>`;
            }
            cont.innerHTML += `<div class="card">
                <h3 style="margin:0; color:var(--blue);">${t.name}</h3>
                <h4 style="margin:5px 0 10px 0; color:var(--danger);">Remaining: ${t.currentPurse.toFixed(2)} Cr</h4>
                <table><thead><tr><th>#</th><th>Player</th><th>Role</th><th>Price</th></tr></thead><tbody>${rows}</tbody></table></div>`;
        });
    }

    function resetAllData() {
        if(confirm("Delete all Firebase Data? This cannot be undone!")) {
            db.ref().remove();
            alert("Database Cleared.");
            location.reload();
        }
    }
</script>
</body>
</html>
        
